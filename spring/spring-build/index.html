



<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
      
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.1, mkdocs-material-4.6.3">
    
    
      
        <title>Spring Modernization - Application Modernization</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/application.adb8469c.css">
      
      
    
    
      <script src="../../assets/javascripts/modernizr.86422ebf.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../../assets/fonts/material-icons.css">
    
    
    
      
    
    
  </head>
  
    <body dir="ltr">
  
    <svg class="md-svg">
      <defs>
        
        
          <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448" viewBox="0 0 416 448" id="__github"><path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19T128 352t-18.125-8.5-10.75-19T96 304t3.125-20.5 10.75-19T128 256t18.125 8.5 10.75 19T160 304zm160 0q0 10-3.125 20.5t-10.75 19T288 352t-18.125-8.5-10.75-19T256 304t3.125-20.5 10.75-19T288 256t18.125 8.5 10.75 19T320 304zm40 0q0-30-17.25-51T296 232q-10.25 0-48.75 5.25Q229.5 240 208 240t-39.25-2.75Q130.75 232 120 232q-29.5 0-46.75 21T56 304q0 22 8 38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0 37.25-1.75t35-7.375 30.5-15 20.25-25.75T360 304zm56-44q0 51.75-15.25 82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5T212 416q-19.5 0-35.5-.75t-36.875-3.125-38.125-7.5-34.25-12.875T37 371.5t-21.5-28.75Q0 312 0 260q0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25 30.875Q171.5 96 212 96q37 0 70 8 26.25-20.5 46.75-30.25T376 64q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34 99.5z"/></svg>
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#spring-modernization" tabindex="0" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="../.." title="Application Modernization" aria-label="Application Modernization" class="md-header-nav__button md-logo">
          
            <i class="md-icon"></i>
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            <span class="md-header-nav__topic">
              Application Modernization
            </span>
            <span class="md-header-nav__topic">
              
                Spring Modernization
              
            </span>
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
          
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" aria-label="search" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
        
      </div>
      
        <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            


  

<a href="https://github.com/ibm-cloud-architecture/cloudpak-for-applications/" title="Go to repository" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    ibm-cloud-architecture/cloudpak-for-applications
  </div>
</a>
          </div>
        </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
      <main class="md-main" role="main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href="../.." title="Application Modernization" class="md-nav__button md-logo">
      
        <i class="md-icon"></i>
      
    </a>
    Application Modernization
  </label>
  
    <div class="md-nav__source">
      


  

<a href="https://github.com/ibm-cloud-architecture/cloudpak-for-applications/" title="Go to repository" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    ibm-cloud-architecture/cloudpak-for-applications
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="../.." title="Introduction" class="md-nav__link">
      Introduction
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../liberty/" title="Runtime modernization" class="md-nav__link">
      Runtime modernization
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../" title="Spring modernization" class="md-nav__link">
      Spring modernization
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../was90/" title="Operational modernization" class="md-nav__link">
      Operational modernization
    </a>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#table-of-contents" class="md-nav__link">
    Table of Contents
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#application-overview" class="md-nav__link">
    Application Overview
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#how-the-application-was-modernized" class="md-nav__link">
    How the Application was Modernized
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#code-changes" class="md-nav__link">
    Code Changes
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#build" class="md-nav__link">
    Build
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#deploy" class="md-nav__link">
    Deploy
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#deploy-the-application" class="md-nav__link">
    Deploy the Application
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#prerequisites" class="md-nav__link">
    Prerequisites
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#getting-the-project-repository" class="md-nav__link">
    Getting the project repository
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#create-the-security-context-constraint" class="md-nav__link">
    Create the Security Context Constraint
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#create-the-projects" class="md-nav__link">
    Create the projects
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#create-a-service-account" class="md-nav__link">
    Create a service account
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#deploy-jenkins" class="md-nav__link">
    Deploy Jenkins
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#update-the-jenkins-service-account" class="md-nav__link">
    Update the Jenkins service account
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#import-the-deployment-templates" class="md-nav__link">
    Import the deployment templates
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#create-the-deployment-definitions" class="md-nav__link">
    Create the deployment definitions
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#import-the-build-templates" class="md-nav__link">
    Import the build templates
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#create-the-build-definitions" class="md-nav__link">
    Create the build definitions
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#run-the-pipeline" class="md-nav__link">
    Run the pipeline
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#validate-the-application" class="md-nav__link">
    Validate the Application
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#summary" class="md-nav__link">
    Summary
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/ibm-cloud-architecture/cloudpak-for-applications/edit/master/docs/spring/spring-build.md" title="Edit this page" class="md-icon md-content__icon">&#xE3C9;</a>
                
                
                <h1 id="spring-modernization">Spring Modernization</h1>
<p><strong>Spring modernization</strong> describes the process of upgrading existing Spring Framework and Spring Boot v1 applications to use <a href="https://spring.io/projects/spring-boot">Spring Boot v2</a>. Pivotal have made some changes to the <a href="https://github.com/spring-projects/spring-framework/wiki/Spring-Framework-Versions">list of supported versions of Spring</a> that may require modernization of existing applications to Spring Boot v2.</p>
<p>With the <a href="https://openliberty.io/">Open Liberty</a> project, IBM have <a href="https://www.ibm.com/cloud/blog/open-liberty-loves-spring">provided support for Spring Boot</a> and made <a href="https://openliberty.io/blog/2018/07/02/creating-dual-layer-docker-images-for-spring-boot-apps.html">optimizations to the runtime and Docker images specifically for Spring Boot</a>.</p>
<p>There are some benefits of running Spring Boot applications on the Open Liberty runtime:</p>
<ul>
<li>
<p>Performance. Benchmarks have shows that Liberty perform better than Tomcat on both throughput and response time.</p>
</li>
<li>
<p>Size.  The memory footprint of Liberty is smaller than tomcat, but more importantly the Spring Boot libraries can be separated from the runtime libraries. When we look at the way Docker builds it's images using layers, the application portion is much smaller if we build out images in the optimized way.  This means faster build time, and if you're storing every version of your application you build, the delta between versions is much smaller</p>
</li>
<li>
<p>Support. If you're running on OpenShift using IBM Cloud Paks, using the Liberty runtime is included in your licensing model, so using Liberty comes at no additional cost, but if need any support for Liberty it's included.  If you stick with standard Spring Boot with tomcat, you'll have to either run on an unsupported platform, or pay for additional support for the tomcat runtime.</p>
</li>
<li>
<p>Consistent runtime model.  Running Liberty has many best practices especially in the Kubernetes/OpenShift world.  There are built in metrics and monitoring tools which are specifically designed to be integrated into OpenShift.  Using Liberty allows you to leverage many if these automatic connections to better maintain your environment.</p>
</li>
</ul>
<p>This repository holds a solution that is the result of a modernization for an Spring application that was upgraded to Spring Boot on Open Liberty and deployed by the IBM CloudPak for Applications to RedHat OpenShift.</p>
<h2 id="table-of-contents">Table of Contents</h2>
<ul>
<li><a href="#application-overview">Application Overview</a></li>
<li><a href="#how-the-application-was-modernized">How the Application was Modernized</a></li>
<li><a href="#code-changes">Code Changes</a></li>
<li><a href="#build">Build</a></li>
<li><a href="#deploy">Deploy</a></li>
<li><a href="#deploy-the-application">Deploy the Application</a></li>
<li><a href="#getting-the-project-repository">Getting the project repository</a></li>
<li><a href="#create-the-security-context-constraint">Create the Security Context Constraint</a></li>
<li><a href="#create-the-projects">Create the projects</a></li>
<li><a href="#create-a-service-account">Create a service account</a></li>
<li><a href="#deploy-jenkins">Deploy Jenkins</a></li>
<li><a href="update-the-jenkins-service-account">Update the Jenkins service account</a></li>
<li><a href="#import-the-deployment-templates">Import the deployment templates</a></li>
<li><a href="#create-the-deployment-definitions">Create the deployment definitions</a></li>
<li><a href="#import-the-build-templates">Import the build templates</a></li>
<li><a href="#create-the-build-definitions">Create the build definitions</a></li>
<li><a href="#run-the-pipeline">Run the pipeline</a></li>
<li><a href="#validate-the-application">Validate the Application</a></li>
<li><a href="#summary">Summary</a></li>
</ul>
<h2 id="application-overview">Application Overview</h2>
<p>Pet Clinic is a demonstration application that was created in 2003 to show the features and functions of the Spring Framework. A description of the original application can be found in the <strong>The Pet Clinic Application</strong> section of the <a href="https://projects.spring.io/spring-petclinic/#quick-start">readme</a></p>
<h2 id="how-the-application-was-modernized">How the Application was Modernized</h2>
<p>In order to modernize the application from the Spring Framework to Spring Boot and Open Liberty running on OpenShift, the application went through <strong>code changes</strong>, <strong>build</strong> and <strong>deploy</strong> phases.</p>
<h3 id="code-changes">Code Changes</h3>
<p>Pet Clinic was modernized by the open source community in 2013 from Spring Framework 2.5 to Spring Framework 3.0 and then in 2016 to Spring Boot. The process of making the code changes is outside of the scope of this document, however the general modernization process is described below:</p>
<ul>
<li><a href="https://github.com/spring-projects/spring-framework/wiki/Upgrading-to-Spring-Framework-5.x">Spring Framework Upgrades</a></li>
<li><a href="https://github.com/spring-projects/spring-boot/wiki/Spring-Boot-2.0-Migration-Guide">Spring Boot Upgrades</a></li>
<li><a href="https://www.baeldung.com/spring-boot-migration">Spring Framework to Spring Boot</a></li>
</ul>
<h3 id="build">Build</h3>
<p>The <strong>build</strong> phase created the Dockerfile for the application.</p>
<p>A Spring Boot application JAR or WAR file is a self-contained artifact. It packages all of the application dependencies inside the final artifact alongside the application content, including an embedded server implementation, such as Tomcat, Jetty, or Undertow. The result is a fat artifact that is easy to run on any server that has a JVM. It also results in a large artifact, even for the smallest hello world Spring Boot web application.</p>
<p>The Pet Clinic <code>Dockerfile</code> for the self-contained jar is shown below:</p>
<div class="codehilite"><pre><span></span><code><span class="err">FROM openliberty/open-liberty:springBoot2-ubi-min</span>
<span class="err">COPY --chown=1001:0 spring-petclinic/target/spring-petclinic-2.1.0.BUILD-SNAPSHOT.jar /config/dropins/spring/</span>
</code></pre></div>


<p>In order to optimize the Docker image, the <a href="https://openliberty.io/blog/2018/07/02/creating-dual-layer-docker-images-for-spring-boot-apps.html">Dual Layer Approach</a> that IBM has created is used and resulted in the <code>Dockerfile</code> shown below:</p>
<div class="codehilite"><pre><span></span><code><span class="k">FROM</span> <span class="n">openliberty</span><span class="o">/</span><span class="k">open</span><span class="o">-</span><span class="n">liberty</span><span class="p">:</span><span class="n">springBoot2</span><span class="o">-</span><span class="n">ubi</span><span class="o">-</span><span class="k">min</span> <span class="k">as</span> <span class="n">staging</span>
<span class="k">USER</span> <span class="n">root</span>
<span class="k">COPY</span> <span class="n">spring</span><span class="o">-</span><span class="n">petclinic</span><span class="o">/</span><span class="n">target</span><span class="o">/</span><span class="n">spring</span><span class="o">-</span><span class="n">petclinic</span><span class="o">-</span><span class="mi">2</span><span class="p">.</span><span class="mi">1</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="n">BUILD</span><span class="o">-</span><span class="n">SNAPSHOT</span><span class="p">.</span><span class="n">jar</span> <span class="o">/</span><span class="n">staging</span><span class="o">/</span><span class="n">fatClinic</span><span class="p">.</span><span class="n">jar</span>

<span class="n">RUN</span> <span class="n">springBootUtility</span> <span class="n">thin</span> <span class="err">\</span>
 <span class="c1">--sourceAppPath=/staging/fatClinic.jar \</span>
 <span class="c1">--targetThinAppPath=/staging/thinClinic.jar \</span>
 <span class="c1">--targetLibCachePath=/staging/lib.index.cache</span>

<span class="k">FROM</span> <span class="n">openliberty</span><span class="o">/</span><span class="k">open</span><span class="o">-</span><span class="n">liberty</span><span class="p">:</span><span class="n">springBoot2</span><span class="o">-</span><span class="n">ubi</span><span class="o">-</span><span class="k">min</span>
<span class="k">USER</span> <span class="n">root</span>
<span class="k">COPY</span> <span class="c1">--from=staging /staging/lib.index.cache /opt/ol/wlp/usr/shared/resources/lib.index.cache</span>
<span class="k">COPY</span> <span class="c1">--from=staging /staging/thinClinic.jar /config/dropins/spring/thinClinic.jar</span>

<span class="n">RUN</span> <span class="n">chown</span> <span class="o">-</span><span class="n">R</span> <span class="mi">1001</span><span class="p">.</span><span class="mi">0</span> <span class="o">/</span><span class="n">config</span> <span class="o">&amp;&amp;</span> <span class="n">chmod</span> <span class="o">-</span><span class="n">R</span> <span class="k">g</span><span class="o">+</span><span class="n">rw</span> <span class="o">/</span><span class="n">config</span>
<span class="n">RUN</span> <span class="n">chown</span> <span class="o">-</span><span class="n">R</span> <span class="mi">1001</span><span class="p">.</span><span class="mi">0</span> <span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">ol</span><span class="o">/</span><span class="n">wlp</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">shared</span><span class="o">/</span><span class="n">resources</span><span class="o">/</span><span class="n">lib</span><span class="p">.</span><span class="k">index</span><span class="p">.</span><span class="k">cache</span> <span class="o">&amp;&amp;</span> <span class="n">chmod</span> <span class="o">-</span><span class="n">R</span> <span class="k">g</span><span class="o">+</span><span class="n">rw</span> <span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">ol</span><span class="o">/</span><span class="n">wlp</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">shared</span><span class="o">/</span><span class="n">resources</span><span class="o">/</span><span class="n">lib</span><span class="p">.</span><span class="k">index</span><span class="p">.</span><span class="k">cache</span>

<span class="k">USER</span> <span class="mi">1001</span>
</code></pre></div>


<p>The final file can be found here:</p>
<ul>
<li>
<p><a href="https://github.com/ibm-cloud-architecture/cloudpak-for-applications/blob/spring/Dockerfile">Dockerfile</a></p>
</li>
<li>
<p>The containerized application was tested locally before the code and configuration files were committed to the <strong>git</strong> repository</p>
</li>
</ul>
<h3 id="deploy">Deploy</h3>
<p>The <strong>deploy</strong> phase created the Jenkins, Kubernetes and Red Hat OpenShift artifacts required to automate the build and deployment pipeline for the application. For illustration purposes, the application was deployed to three different Red Hat OpenShift projects to simulate <code>development</code>, <code>staging</code> and <code>production</code>. The diagram below shows the flow through the pipeline. A more detailed description can be found <a href="liberty-deploy.md">here</a></p>
<p><img alt="Pipeline" src="../images/overview.jpg" /></p>
<p>The steps were:</p>
<ol>
<li>
<p>Configure the Red Hat OpenShift Cluster for WebSphere by creating the necessary <code>SecurityContextConstraints</code> definition. The file can be found here:</p>
</li>
<li>
<p><a href="https://github.com/ibm-cloud-architecture/cloudpak-for-applications/blob/spring/Deployment/OpenShift/ssc.yaml">scc.yaml</a></p>
</li>
<li>
<p>Create the Red Hat OpenShift <strong>build template</strong> that would be used to define the Red Hat OpenShift artifacts related to the build process including <code>ImageStream</code> and <code>BuildConfig</code> definitions. The file can be found here:</p>
</li>
<li>
<p><a href="https://github.com/ibm-cloud-architecture/cloudpak-for-applications/blob/spring/Deployment/OpenShift/template-liberty-build.yaml">template-libery-build.yaml</a></p>
</li>
<li>
<p>Create the Red Hat OpenShift <strong>deployment template</strong> that would be used to define the Red Hat OpenShift artifacts related to the Pet Clinic application including <code>DeploymentConfig</code>, <code>Service</code> and <code>Route</code> definitions. The file can be found here:</p>
</li>
<li>
<p><a href="https://github.com/ibm-cloud-architecture/cloudpak-for-applications/blob/spring/Deployment/OpenShift/template-liberty-deploy.yaml">template-libery-deploy.yaml</a></p>
</li>
<li>
<p>Create the Jenkins <code>Jenkinsfile</code> for the pipeline. The Jenkinsfile defines the steps that the pipeline takes to build the Pet Clinic application, create an immutable Docker Image and then move the image through the <code>dev</code>, <code>stage</code> and <code>prod</code> environments. The file can be found here:</p>
</li>
<li>
<p><a href="https://github.com/ibm-cloud-architecture/cloudpak-for-applications/blob/spring/Jenkinsfile">Jenkinsfile</a></p>
</li>
<li>
<p>Create the <code>build</code> project, load the <strong>build template</strong> and configure <strong>Jenkins</strong></p>
</li>
<li>
<p>Create the <code>dev</code>, <code>stage</code> and <code>prod</code> projects and load the <strong>deployment template</strong></p>
</li>
<li>
<p>Verify the pipeline.</p>
</li>
</ol>
<p>Detailed, step-by-step instructions on how to replicate these steps are provided <a href="liberty-deploy.md">here</a></p>
<h2 id="deploy-the-application">Deploy the Application</h2>
<p>The following steps will deploy the modernized Pet Clinic application in a Open Liberty container to a Red Hat OpenShift cluster.</p>
<h3 id="prerequisites">Prerequisites</h3>
<p>You will need the following:</p>
<ul>
<li><a href="https://git-scm.com/book/en/v2/Getting-Started-Installing-Git">Git CLI</a></li>
<li>Red Hat OpenShift 3.11 with Cluster Admin permissions</li>
<li><a href="https://docs.openshift.com/container-platform/3.11/cli_reference/get_started_cli.html">oc CLI</a></li>
<li>DB2 Database</li>
</ul>
<h3 id="getting-the-project-repository">Getting the project repository</h3>
<p>You can clone the repository from its main GitHub repository page and checkout the appropriate branch for this version of the application.</p>
<div class="codehilite"><pre><span></span><code><span class="err">git clone https://github.com/ibm-cloud-architecture/cloudpak-for-applications.git</span>
<span class="err">cd cloudpak-for-applications</span>
<span class="err">git checkout spring</span>
</code></pre></div>


<h3 id="create-the-security-context-constraint">Create the Security Context Constraint</h3>
<p>In order to deploy and run the Open Liberty Docker image in an OpenShift cluster, we first need to configure certain security aspects for the cluster. The <code>Security Context Constraint</code> provided <a href="https://github.com/ibm-cloud-architecture/cloudpak-for-applications/blob/spring/Deployment/OpenShift/ssc.yaml">here</a> grants the <a href="https://kubernetes.io/docs/tasks/configure-pod-container/configure-service-account/">service account</a> that the Open Liberty Docker container is running under the required privileges to function correctly.</p>
<p>A <strong>cluster administrator</strong> can use the file provided <a href="https://github.com/ibm-cloud-architecture/cloudpak-for-applications/blob/spring/Deployment/OpenShift/ssc.yaml">here</a> with the following command to create the Security Context Constraint (SCC):</p>
<div class="codehilite"><pre><span></span><code><span class="err">cd Deployment/OpenShift</span>
<span class="err">oc apply -f ssc.yaml</span>
</code></pre></div>


<h3 id="create-the-projects">Create the projects</h3>
<p>Four Red Hat OpenShift projects are required in this scenario:
- Build: this project will contain the Jenkins server and the artifacts used to build the application image<br />
- Dev: this is the <code>development</code> environment for this application
- Stage: this is the <code>staging</code> environment for this application
- Prod: this is the <code>production</code> environment for this application</p>
<p>The file provided <a href="https://github.com/ibm-cloud-architecture/cloudpak-for-applications/blob/spring/Deployment/OpenShift/liberty-projects.yaml">here</a> contains the definitions for the four projects in a single file to make creation easier</p>
<p>Issue the command shown below to create the projects</p>
<div class="codehilite"><pre><span></span><code><span class="err">oc create -f liberty-projects.yaml</span>
</code></pre></div>


<h3 id="create-a-service-account">Create a service account</h3>
<p>It is a good Kubernetes practice to create a <a href="https://kubernetes.io/docs/tasks/configure-pod-container/configure-service-account/">service account</a> for your applications. A service account provides an identity for processes that run in a Pod. In this step we will create a new service account with the name <code>websphere</code> in each of the <code>dev</code>, <code>stage</code> and <code>prod</code> projects and add the Security Context Constraint created above to them.</p>
<p>Issue the commands shown below to create the <code>websphere</code> service account and bind the ibm-websphere-scc to it in each of the projects:</p>
<div class="codehilite"><pre><span></span><code><span class="err">oc create serviceaccount websphere -n petclinic-liberty-dev</span>
<span class="err">oc create serviceaccount websphere -n petclinic-liberty-stage</span>
<span class="err">oc create serviceaccount websphere -n petclinic-liberty-prod</span>
<span class="err">oc adm policy add-scc-to-user ibm-websphere-scc -z websphere -n petclinic-liberty-dev</span>
<span class="err">oc adm policy add-scc-to-user ibm-websphere-scc -z websphere -n petclinic-liberty-stage</span>
<span class="err">oc adm policy add-scc-to-user ibm-websphere-scc -z websphere -n petclinic-liberty-prod</span>
</code></pre></div>


<h3 id="deploy-jenkins">Deploy Jenkins</h3>
<p>Some Red Hat OpenShift clusters are configured to automatically provision a Jenkins instance in a build project. The steps below can be used if your cluster is not configured for automatic Jenkins provisioning:</p>
<div class="codehilite"><pre><span></span><code><span class="err">oc project petclinic-liberty-build</span>
<span class="err">oc new-app jenkins-persistent</span>
</code></pre></div>


<h2 id="update-the-jenkins-service-account">Update the Jenkins service account</h2>
<p>During provisioning of the Jenkins master a service account with the name <code>jenkins</code> is created. This service account has privileges to create new artifacts only in the project that it is running in. In this scenario Jenkins will need to create artifacts in the <code>dev</code>, <code>stage</code> and <code>prod</code> projects.</p>
<p>Issue the commands below to allow the <code>jenkins</code> service account to <code>edit</code> artifacts in the <code>dev</code>, <code>stage</code> and <code>prod</code> projects.</p>
<div class="codehilite"><pre><span></span><code><span class="err">oc policy add-role-to-user edit system:serviceaccount:petclinic-liberty-build:jenkins -n petclinic-liberty-dev</span>
<span class="err">oc policy add-role-to-user edit system:serviceaccount:petclinic-liberty-build:jenkins -n petclinic-liberty-stage</span>
<span class="err">oc policy add-role-to-user edit system:serviceaccount:petclinic-liberty-build:jenkins -n petclinic-liberty-prod</span>
</code></pre></div>


<h3 id="import-the-deployment-templates">Import the deployment templates</h3>
<p>Red Hat OpenShift <a href="https://docs.openshift.com/container-platform/3.11/dev_guide/templates.html">templates</a> are used to make artifact creation easier and repeatable. The template definition provided <a href="https://github.com/ibm-cloud-architecture/cloudpak-for-applications/blob/spring/Deployment/OpenShift/template-liberty-deploy.yaml">here</a> defines a Kubernetes <a href="https://kubernetes.io/docs/concepts/services-networking/service/"><code>Service</code></a>, <a href="https://docs.openshift.com/container-platform/3.11/architecture/networking/routes.html"><code>Route</code></a> and <a href="https://docs.openshift.com/container-platform/3.11/architecture/core_concepts/deployments.html#deployments-and-deployment-configurations"><code>DeploymentConfig</code></a> for the CustomerOrderServices application.</p>
<p>The <code>gse-spring-deploy</code> template defines the following:
- <code>service</code> listening on ports <code>9080</code>, <code>9443</code> and <code>9082</code>
- <code>route</code> to expose the <code>9443</code> port externally
- <code>DeploymentConfig</code> to host the Open Liberty container.
  - The <code>image</code> for the container is taken from the <a href="https://docs.openshift.com/container-platform/3.11/dev_guide/managing_images.html"><code>ImageStream</code></a> that will be populated by the Jenkins pipeline.
  - <code>environment variables</code> are defined for the DB2 database used by the application allowing for environment specific information to be injected
  - <a href="https://kubernetes.io/docs/tasks/configure-pod-container/configure-liveness-readiness-probes/">Probes</a> for <code>liveness</code> and <code>readiness</code> are defined to check port 9443 is active
  - The <code>securityContext</code> is set to allow read/write access to the filesystem and to run the container as <code>user 1001</code>
  - The deployment will be updated if a new image is loaded to the <code>ImageStream</code> or if a change to the configuration is detected.</p>
<p>Issue the commands below to load the template named <code>gse-spring-deploy</code> in the <code>dev</code>, <code>stage</code> and <code>prod</code> projects.</p>
<div class="codehilite"><pre><span></span><code><span class="err">oc create -f template-liberty-deploy.yaml -n petclinic-liberty-dev</span>
<span class="err">oc create -f template-liberty-deploy.yaml -n petclinic-liberty-stage</span>
<span class="err">oc create -f template-liberty-deploy.yaml -n petclinic-liberty-prod</span>
</code></pre></div>


<h3 id="create-the-deployment-definitions">Create the deployment definitions</h3>
<p>In this step the <code>gse-spring-deploy</code> template will be used to create a Red Hat OpenShift <a href="https://docs.openshift.com/container-platform/3.11/dev_guide/application_lifecycle/new_app.html">application</a> named <code>petclinic-liberty</code> in the <code>dev</code>, <code>stage</code> and <code>prod</code> namespaces.</p>
<p>The result will be:
- <code>service</code> listening on ports <code>9080</code>, <code>9443</code> and <code>9082</code>
- <code>route</code> to expose the <code>9443</code> port externally
- <code>DeploymentConfig</code> to host the Open Liberty container. The deployment config will wait for a <code>docker image</code> to be loaded in to the <code>ImageStream</code> by the Jenkins pipeline.</p>
<p>Issue the following commands to create the applications from the template:</p>
<div class="codehilite"><pre><span></span><code><span class="err">oc new-app gse-spring-deploy -p APPLICATION_NAME=petclinic-liberty -n petclinic-liberty-dev</span>
<span class="err">oc new-app gse-spring-deploy -p APPLICATION_NAME=petclinic-liberty -n petclinic-liberty-stage</span>
<span class="err">oc new-app gse-spring-deploy -p APPLICATION_NAME=petclinic-liberty -n petclinic-liberty-prod</span>
</code></pre></div>


<h3 id="import-the-build-templates">Import the build templates</h3>
<p>In this step a template for the <code>build</code> process will be loaded in to the <code>build</code> project. The template provided <a href="https://github.com/ibm-cloud-architecture/cloudpak-for-applications/blob/spring/Deployment/OpenShift/template-liberty-build.yaml">here</a> defines the following artifacts:</p>
<ul>
<li>An <a href="https://docs.openshift.com/container-platform/3.11/dev_guide/managing_images.html">ImageStream</a> for the application image. This will be populated by the Jenkins Pipeline</li>
<li>An ImageStream for Open Liberty which will pull down the latest version of the <code>openliberty/open-liberty:springBoot2-ubi-min</code> image and will monitor DockerHub for any updates.</li>
<li>A <code>binary</code> <a href="https://docs.openshift.com/container-platform/3.11/dev_guide/builds/build_strategies.html">BuildConfig</a> that will be used by the Jenkins Pipeline to build the application Docker image</li>
<li>A <code>jenkinsfile</code> BuildConfig that defines the <code>Pipeline</code> using the <code>Jenkinsfile</code> in GitHub</li>
<li>Parameters to allow the Open Liberty image and GitHub repository to be provided when the template is instantiated</li>
</ul>
<p>Issue the commands below to load the template named <code>gse-springboot-build</code> in the <code>build</code> projects.</p>
<div class="codehilite"><pre><span></span><code><span class="err">oc create -f template-liberty-build.yaml -n petclinic-liberty-build</span>
</code></pre></div>


<h3 id="create-the-build-definitions">Create the build definitions</h3>
<p>In this step the <code>gse-springboot-build</code> template will be used to create a Red Hat OpenShift <a href="https://docs.openshift.com/container-platform/3.11/dev_guide/application_lifecycle/new_app.html">application</a> named <code>petclinic-liberty</code> in the <code>build</code> namespaces.</p>
<p>The result will be:
- An <a href="https://docs.openshift.com/container-platform/3.11/dev_guide/managing_images.html">ImageStream</a> for the application image. This will be populated by the Jenkins Pipeline
- An ImageStream for Open Liberty which will pull down the latest version of the <code>openliberty/open-liberty:springBoot2-ubi-min</code> image and will monitor DockerHub for any updates.
- A <code>binary</code> <a href="https://docs.openshift.com/container-platform/3.11/dev_guide/builds/build_strategies.html">BuildConfig</a> that will be used by the Jenkins Pipeline to build the application Docker image
- A <code>jenkinsfile</code> BuildConfig that defines the <code>Pipeline</code> using the <code>Jenkinsfile</code> in GitHub (with the URL provided as a parameter when the application is created)</p>
<p>Issue the following commands to create the application from the template:</p>
<div class="codehilite"><pre><span></span><code><span class="err">oc new-app gse-springboot-build -p APPLICATION_NAME=petclinic-liberty -p SOURCE_URL=&quot;https://github.com/ibm-cloud-architecture/cloudpak-for-applications&quot; -n petclinic-liberty-build</span>
</code></pre></div>


<h3 id="run-the-pipeline">Run the pipeline</h3>
<p>The newly created pipeline can be started from the Red Hat OpenShift console which allows access to the Jenkins logs but also tracks the progress in the OCP console.</p>
<ol>
<li>Navigate to <strong>Application Console --&gt; Pet Clinic on Liberty - Build --&gt; Builds --&gt; Pipelines</strong> and click the <strong>Start Pipeline</strong> button</li>
</ol>
<p><img alt="Run Pipeline" src="../images/run-pipeline.jpg" /></p>
<ol>
<li>When the pipeline starts, click the <code>view log</code> link to go to the Jenkins administration console. Note that it may take a couple of minutes before the <code>view log</code> link appears on the first pipeline build</li>
</ol>
<p><img alt="View Log" src="../images/view-log.jpg" /></p>
<ol>
<li>When prompted, log in with your OpenShift account and grant the required access permissions. The Jenkins console log will be displayed as shown below:</li>
</ol>
<p><img alt="Jenkins Log" src="../images/jenkins-log.jpg" /></p>
<ol>
<li>Return to the OpenShift Console and track the progress of the pipeline</li>
</ol>
<p><img alt="Running" src="../images/pipeline-running.jpg" /></p>
<ol>
<li>The pipeline will eventually stop at the <strong>Promotion Gate</strong> for approval to deploy to Production. Click the <strong>Input Required</strong> link as shown below</li>
</ol>
<p><img alt="Gate" src="../images/gate.jpg" /></p>
<ol>
<li>When the <em>Promote application to Production</em> question is displayed, click <strong>Proceed</strong></li>
</ol>
<p><img alt="Promote" src="../images/promote.jpg" /></p>
<ol>
<li>Return to the OpenShift Console and validate that the pipeline is now complete</li>
</ol>
<p><img alt="Complete" src="../images/complete.jpg" /></p>
<h2 id="validate-the-application">Validate the Application</h2>
<p>Now that the pipeline is complete, validate the Pet Clinic application is deployed and running in <code>dev</code>, <code>stage</code> and <code>prod</code></p>
<ol>
<li>In the OpenShift Console, navigate to <strong>Application Console --&gt; Pet Clinic on Liberty - Dev --&gt; Applications --&gt; Deployments</strong> and click on the link in the <strong>Latest Version</strong> column</li>
</ol>
<p><img alt="Deployment" src="../images/deployment.jpg" /></p>
<ol>
<li>Information about the deployment will be displayed including the <strong>image</strong> that is being used (note the <strong>tag</strong> on the image as it will be the same in the <code>stage</code> and <code>prod</code> deployments). After a few minutes the container will be marked as <strong>ready</strong></li>
</ol>
<p><img alt="Pods" src="../images/pod.jpg" /></p>
<ol>
<li>Click <strong>Applications --&gt; Routes</strong> and click on the <strong>route</strong> for the application. Note that the URL is &lt; application_name &gt;-&lt; project_name &gt;.&lt; ocp cluster url &gt;. In this case the project name is <code>petclinic-liberty-dev</code></li>
</ol>
<p><img alt="Route" src="../images/route.jpg" /></p>
<ol>
<li>The application home page will be displayed. Click <strong>Find Owners</strong> and then <strong>Find Owner</strong> to view a list of owners from the database.</li>
</ol>
<p><img alt="Dev Running" src="../images/running.jpg" /></p>
<ol>
<li>Repeat the validations for the <code>stage</code> and <code>prod</code> Projects.</li>
</ol>
<h2 id="summary">Summary</h2>
<p>This application has been modified from the initial Spring Framework version to Spring Boot v2 to run on Open Liberty and deployed by the IBM CloudPak for Applications.</p>
                
                  
                
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        powered by
        <a href="https://www.mkdocs.org" target="_blank" rel="noopener">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs</a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../assets/javascripts/application.c33a9706.js"></script>
      
      <script>app.initialize({version:"1.1",url:{base:"../.."}})</script>
      
    
  </body>
</html>